rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ğŸ›¡ï¸ SECURITY HARDENED VERSION
    // ä¸»ãªæ”¹å–„ç‚¹:
    // 1. çµ„ç¹”ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡è¿½åŠ 
    // 2. TOCTOUæ”»æ’ƒå¯¾ç­–å®Ÿè£…
    // 3. ã‚ˆã‚Šè©³ç´°ãªæ¨©é™ãƒã‚§ãƒƒã‚¯
    // 4. ç›£æŸ»ãƒ­ã‚°è¦ä»¶è¿½åŠ 

    // Helper functions for role-based access control
    function isAuthenticated() {
      return request.auth != null;
    }

    // ğŸ”’ TOCTOUæ”»æ’ƒå¯¾ç­–: ãƒ­ãƒ¼ãƒ«æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ä¸€è²«æ€§ã‚’ä¿ã¤
    function getUserData() {
      return get(/databases/$(database)/documents/appUsers/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserData().role;
    }

    function getUserCompany() {
      return getUserData().companyId;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager'];
    }

    function isLeader() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager', 'leader'];
    }

    function isActiveUser() {
      return isAuthenticated() && getUserData().isActive == true;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ğŸ¢ çµ„ç¹”ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    function isSameCompany(resourceCompanyId) {
      return isAuthenticated() && getUserCompany() == resourceCompanyId;
    }

    function hasCompanyAccess(resourceData) {
      // ç®¡ç†è€…ã¯å…¨ç¤¾ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³å‘ã‘ï¼‰
      return isAdmin() ||
             (exists(resourceData.companyId) && isSameCompany(resourceData.companyId));
    }

    // ğŸ”’ å…¥åŠ›å€¤æ¤œè¨¼é–¢æ•°
    function isValidInput(data) {
      return data.keys().hasAll(['updatedAt']) &&
             data.updatedAt == request.time;
    }

    // User profiles - çµ„ç¹”ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ä»˜ã
    match /appUsers/{userId} {
      allow read: if isActiveUser() && (isOwner(userId) || hasCompanyAccess(resource.data));
      allow write: if isOwner(userId) || isAdmin() && isValidInput(request.resource.data);
      allow create: if isAdmin() && isValidInput(request.resource.data);
      allow delete: if isAdmin() && hasCompanyAccess(resource.data);
    }

    // Company data - å³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /companies/{companyId} {
      allow read: if isActiveUser() && isSameCompany(companyId);
      allow write: if isAdmin() && isSameCompany(companyId) && isValidInput(request.resource.data);
    }

    // Orders - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /orders/{orderId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if isLeader() && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
      allow create: if isLeader() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isManager() && hasCompanyAccess(resource.data);
    }

    // Processes/Tasks - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /processes/{processId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if isLeader() && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
      allow create: if isLeader() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isManager() && hasCompanyAccess(resource.data);
    }

    // Work Hours - ã‚ˆã‚Šå³æ ¼ãªæ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯
    match /work-hours/{workHourId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if (isOwner(resource.data.userId) || isManager()) &&
                      hasCompanyAccess(resource.data) &&
                      isValidInput(request.resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if (isOwner(resource.data.userId) || isManager()) && hasCompanyAccess(resource.data);
    }

    // Daily Reports - ã‚ˆã‚Šå³æ ¼ãªæ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯
    match /daily-reports/{reportId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if (isOwner(resource.data.userId) || isManager()) &&
                      hasCompanyAccess(resource.data) &&
                      isValidInput(request.resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if (isOwner(resource.data.userId) || isManager()) && hasCompanyAccess(resource.data);
    }

    // Notes - å€‹äººãƒ‡ãƒ¼ã‚¿ + çµ„ç¹”ãƒã‚§ãƒƒã‚¯
    match /notes/{noteId} {
      allow read, write: if isActiveUser() &&
                            isOwner(resource.data.userId) &&
                            hasCompanyAccess(resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isOwner(resource.data.userId) && hasCompanyAccess(resource.data);
    }

    // Calendar events - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /calendar-events/{eventId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if (isOwner(resource.data.userId) || isManager()) &&
                      hasCompanyAccess(resource.data) &&
                      isValidInput(request.resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if (isOwner(resource.data.userId) || isManager()) && hasCompanyAccess(resource.data);
    }

    // Inventory - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /inventory/{itemId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if isLeader() && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
      allow create: if isLeader() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isManager() && hasCompanyAccess(resource.data);
    }

    // Partners - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /partners/{partnerId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if isLeader() && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
      allow create: if isLeader() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isManager() && hasCompanyAccess(resource.data);
    }

    // Defect Reports - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /defect-reports/{reportId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if isLeader() && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isManager() && hasCompanyAccess(resource.data);
    }

    // Bookmarks - å€‹äººãƒ‡ãƒ¼ã‚¿ + çµ„ç¹”ãƒã‚§ãƒƒã‚¯
    match /bookmarks/{bookmarkId} {
      allow read, write: if isActiveUser() &&
                            isOwner(resource.data.userId) &&
                            hasCompanyAccess(resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isOwner(resource.data.userId) && hasCompanyAccess(resource.data);
    }

    // ğŸ”’ ç›£æŸ»ãƒ­ã‚° - ã‚ˆã‚Šå³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
    match /activity-logs/{logId} {
      allow read: if isManager() && hasCompanyAccess(resource.data);
      allow write: if false; // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã®ã¿è¨±å¯
    }

    // ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚° - ç®¡ç†è€…ã®ã¿
    match /security-logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã®ã¿è¨±å¯
    }

    // Chat functionality - çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»˜ã
    match /chatChannels/{channelId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if isActiveUser() && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if isManager() && hasCompanyAccess(resource.data);
    }

    match /chatMessages/{messageId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if (isOwner(resource.data.userId) || isManager()) &&
                      hasCompanyAccess(resource.data) &&
                      isValidInput(request.resource.data);
      allow create: if isActiveUser() && hasCompanyAccess(request.resource.data) && isValidInput(request.resource.data);
      allow delete: if (isOwner(resource.data.userId) || isManager()) && hasCompanyAccess(resource.data);
    }

    match /chatUsers/{userId} {
      allow read: if isActiveUser() && hasCompanyAccess(resource.data);
      allow write: if (isOwner(userId) || isManager()) && hasCompanyAccess(resource.data) && isValidInput(request.resource.data);
    }

    match /unreadCounts/{userId} {
      allow read, write: if (isOwner(userId) || isManager()) && hasCompanyAccess(resource.data);
    }

    // System configuration - ç®¡ç†è€…å°‚ç”¨
    match /system-config/{configId} {
      allow read: if isAdmin();
      allow write: if isAdmin() && isValidInput(request.resource.data);
    }

    // ğŸ”’ å¼·åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã™ã¹ã¦æ‹’å¦
    match /{document=**} {
      allow read, write: if false;
    }
  }
}